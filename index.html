<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Kissingwolf's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="任何复杂纷乱的问题都有简单朴实的解决方案">
<meta property="og:type" content="website">
<meta property="og:title" content="Kissingwolf's Blog">
<meta property="og:url" content="http://blog.kissingwolf.com/index.html">
<meta property="og:site_name" content="Kissingwolf's Blog">
<meta property="og:description" content="任何复杂纷乱的问题都有简单朴实的解决方案">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kissingwolf's Blog">
<meta name="twitter:description" content="任何复杂纷乱的问题都有简单朴实的解决方案">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.kissingwolf.com/"/>





  <title> Kissingwolf's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88598932-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Kissingwolf's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">任何复杂纷乱的问题都有简单朴实的解决方案</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/09/09/Docker-故障（device-or-resource-busy）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/09/Docker-故障（device-or-resource-busy）/" itemprop="url">
                  Docker 故障（device or resource busy）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-09T13:10:41+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/09/09/Docker-故障（device-or-resource-busy）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/09/Docker-故障（device-or-resource-busy）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="2017-09-05-AppOS-Docker重启故障（device-or-resource-busy）"><a href="#2017-09-05-AppOS-Docker重启故障（device-or-resource-busy）" class="headerlink" title="2017-09-05 AppOS Docker重启故障（device or resource busy）"></a>2017-09-05 AppOS Docker重启故障（device or resource busy）</h1><h2 id="故障原因"><a href="#故障原因" class="headerlink" title="故障原因"></a>故障原因</h2><ol>
<li>CentOS/RedHat 3.10.0内核NameSpace bug，由于Systemd PrivateTmp设置导致私有名字空间维护挂接磁盘状态影响全局空间卸载磁盘。</li>
<li>基于systemd 方式的ntpd 服务启动配置文件中设置“PrivateTmp=true”，导致ntpd 私有名字空间中挂接信息（/proc/$ntpd_pid/mounts）存在docker container 挂接磁盘信息，Docker 销毁container时需要卸载挂接磁盘，此时出现冲突导致docker 销毁container动作失败。</li>
<li>Docker 创建、运行、新增container和image时不会遇到这个Bug，仅在销毁container时由于无法卸载挂接镜像磁盘导致出错。</li>
<li>Docker 无论使用哪种storage-driver均有此问题，问题并不仅仅出现在使用devicemapper storage-driver时。</li>
<li>CentOS7系统中默认会激活此Bug的服务除ntpd外包括：brandbot.service、dbus-org.freedesktop.hostname1.service、dbus-org.freedesktop.import1.service、dbus-org.freedesktop.locale1.service、dbus-org.freedesktop.machine1.service、dbus-org.freedesktop.timedate1.service、httpd.service、systemd-hostnamed.service、systemd-importd.service、systemd-localed.service、systemd-machined.service、systemd-timedated.service。</li>
<li>任何使用<code>unshare</code>方式运行的进程均会激活此Bug。</li>
</ol>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol>
<li>启动docker服务前修改<code>/usr/lib/systemd/system/docker.service</code>配置文件<code>[Service]</code>段中加入<code>MountFlags=slave</code>，然后<code>systemctl daemon-reload</code>，重新启动docker后，docker container挂接的磁盘将独立于全局磁盘挂接，不会再受到“Systemd PrivateTmp”影响。</li>
<li>已受“Systemd PrivateTmp”影响的状态下，Docker 无法销毁container时，systemctl方式重启设置“PrivateTmp=true”的服务后，Docker就可以销毁执行了<code>docker rm -f container_name</code>的container，但再销毁新的container时，还需要重启重启设置“PrivateTmp=true”的服务。</li>
<li>此问题CentOS/RedHat在CentOS 7.4 /RHEL 7.4 时（kernel-3.10.0-693)时会环境，但依旧没有根治，相同环境下CentOS 7.4/RHEL7.4(kernel-3.10.0-693)会报错，但不会影响操作。</li>
</ol>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><ul>
<li>环境说明：kernel: 3.10.0-514.26.2.el7.x86_64 , docker:17.06.2.ce-1,ntp:4.2.6p5-25</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># uname -a</span></div><div class="line">Linux kevinzou.kissingwolf.com 3.10.0-514.26.2.el7.x86_64 <span class="comment">#1 SMP Tue Jul 4 15:04:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></div><div class="line">[root@kevinzou ~]<span class="comment"># rpm -q docker-ce</span></div><div class="line">docker-ce-17.06.2.ce-1.el7.centos.x86_64</div><div class="line">[root@kevinzou ~]<span class="comment"># rpm -q ntp</span></div><div class="line">ntp-4.2.6p5-25.el7.centos.2.x86_64</div></pre></td></tr></table></figure>
<ul>
<li>在docker devicemapper storage-driver环境下复现问题</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># systemctl start ntpd</span></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl start docker</span></div><div class="line">[root@kevinzou ~]<span class="comment"># docker info</span></div><div class="line">Containers: 1</div><div class="line"> Running: 0</div><div class="line"> Paused: 0</div><div class="line"> Stopped: 1</div><div class="line">Images: 1</div><div class="line">Server Version: 17.06.2-ce</div><div class="line">Storage Driver: devicemapper</div><div class="line"> Pool Name: docker-253:0-101567388-pool</div><div class="line"> Pool Blocksize: 65.54kB</div><div class="line"> Base Device Size: 10.74GB</div><div class="line"> ....</div><div class="line"> </div><div class="line"> [root@kevinzou ~]<span class="comment"># lsns</span></div><div class="line">        NS TYPE  NPROCS   PID USER COMMAND</div><div class="line">4026531836 pid      205     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531837 user     205     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531838 uts      205     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531839 ipc      205     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531840 mnt      199     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531856 mnt        1    17 root kdevtmpfs</div><div class="line">4026531956 net      205     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026532462 mnt        1   587 root /usr/lib/systemd/systemd-udevd</div><div class="line">4026532463 mnt        1   774 root /usr/bin/vmtoolsd</div><div class="line">4026532547 mnt        2   802 root /usr/sbin/NetworkManager --no-daemon</div><div class="line">4026532548 mnt        1  1415 ntp  /usr/sbin/ntpd -u ntp:ntp -g</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker run -d busybox /bin/sh -c "while : ; do sleep 1000 ; done"</span></div><div class="line">7795c776e4d0dd704a146cb17ffa16340aed88abd39e1a18ae8675c29a9ea606</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># df</span></div><div class="line">Filesystem           1K-blocks    Used Available Use% Mounted on</div><div class="line">/dev/mapper/vg0-root  52403200 3211128  49192072   7% /</div><div class="line">devtmpfs                986864       0    986864   0% /dev</div><div class="line">tmpfs                   997636       0    997636   0% /dev/shm</div><div class="line">tmpfs                   997636     780    996856   1% /run</div><div class="line">tmpfs                   997636       0    997636   0% /sys/fs/cgroup</div><div class="line">/dev/sda5             20971520   16928  18856704   1% /home</div><div class="line">/dev/sda1               201380  164836     36544  82% /boot</div><div class="line">/dev/mapper/vg0-opt   10190100   36892   9612536   1% /opt</div><div class="line">tmpfs                   199528       0    199528   0% /run/user/0</div><div class="line">/dev/dm-3             10474496   34920  10439576   1% /var/lib/docker/devicemapper/mnt/589d673ac29d6128fbcc90edc6f644a6c71900a577303b5cbf2ad3b61619fbca</div><div class="line">shm                      65536       0     65536   0% /var/lib/docker/containers/7795c776e4d0dd704a146cb17ffa16340aed88abd39e1a18ae8675c29a9ea606/shm</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl status ntpd |grep PID</span></div><div class="line"> Main PID: 1415 (ntpd)</div><div class="line">[root@kevinzou ~]<span class="comment"># grep devicemapper /proc/1415/mounts</span></div><div class="line">/dev/mapper/vg0-root /var/lib/docker/devicemapper xfs rw,seclabel,relatime,attr2,inode64,noquota 0 0</div></pre></td></tr></table></figure>
<p>先启动ntpd服务，后启动docker服务并创建container，不会有任何问题。</p>
<ul>
<li>重启ntpd服务，激活bug</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># systemctl restart ntpd</span></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl status ntpd |grep PID</span></div><div class="line"> Main PID: 1942 (ntpd)</div><div class="line">[root@kevinzou ~]<span class="comment"># grep devicemapper /proc/1942/mounts</span></div><div class="line">/dev/mapper/vg0-root /var/lib/docker/devicemapper xfs rw,seclabel,relatime,attr2,inode64,noquota 0 0</div><div class="line">/dev/mapper/docker-253:0-101567388-589d673ac29d6128fbcc90edc6f644a6c71900a577303b5cbf2ad3b61619fbca /var/lib/docker/devicemapper/mnt/589d673ac29d6128fbcc90edc6f644a6c71900a577303b5cbf2ad3b61619fbca xfs rw,seclabel,relatime,nouuid,attr2,inode64,logbsize=64k,sunit=128,swidth=128,noquota 0 0</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker rm -f $(docker ps -q)</span></div><div class="line">Error response from daemon: driver <span class="string">"devicemapper"</span> failed to remove root filesystem <span class="keyword">for</span> 7795c776e4d0dd704a146cb17ffa16340aed88abd39e1a18ae8675c29a9ea606: failed to remove device 589d673ac29d6128fbcc90edc6f644a6c71900a577303b5cbf2ad3b61619fbca: Device is Busy</div><div class="line">此时hang住了大概10s，而后确定删除</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker ps</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div></pre></td></tr></table></figure>
<ul>
<li>在docker overlay storage-driver环境下复现问题</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># systemctl start ntpd</span></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl  start docker</span></div><div class="line">[root@kevinzou ~]<span class="comment"># docker info</span></div><div class="line">Containers: 5</div><div class="line"> Running: 0</div><div class="line"> Paused: 0</div><div class="line"> Stopped: 5</div><div class="line">Images: 1</div><div class="line">Server Version: 17.06.2-ce</div><div class="line">Storage Driver: overlay</div><div class="line"> Backing Filesystem: xfs</div><div class="line"> Supports d_type: <span class="literal">true</span></div><div class="line">Logging Driver: json-file</div><div class="line">Cgroup Driver: cgroupfs</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># lsns</span></div><div class="line">        NS TYPE  NPROCS   PID USER COMMAND</div><div class="line">4026531836 pid      215     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531837 user     215     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531838 uts      215     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531839 ipc      215     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531840 mnt      209     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531856 mnt        1    17 root kdevtmpfs</div><div class="line">4026531956 net      215     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026532462 mnt        1   587 root /usr/lib/systemd/systemd-udevd</div><div class="line">4026532463 mnt        1   774 root /usr/bin/vmtoolsd</div><div class="line">4026532547 mnt        2   802 root /usr/sbin/NetworkManager --no-daemon</div><div class="line">4026532548 mnt        1  1942 ntp  /usr/sbin/ntpd -u ntp:ntp -g</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker run -d busybox /bin/sh -c "while : ; do sleep 1000 ; done"</span></div><div class="line">58818b40586e230715df416779ec23799000616b0f0c09686ca1ccc9a8a4401d</div><div class="line">[root@kevinzou ~]<span class="comment"># df</span></div><div class="line">Filesystem           1K-blocks    Used Available Use% Mounted on</div><div class="line">/dev/mapper/vg0-root  52403200 3211932  49191268   7% /</div><div class="line">devtmpfs                986864       0    986864   0% /dev</div><div class="line">tmpfs                   997636       0    997636   0% /dev/shm</div><div class="line">tmpfs                   997636     780    996856   1% /run</div><div class="line">tmpfs                   997636       0    997636   0% /sys/fs/cgroup</div><div class="line">/dev/sda5             20971520   16928  18856704   1% /home</div><div class="line">/dev/sda1               201380  164836     36544  82% /boot</div><div class="line">/dev/mapper/vg0-opt   10190100   36892   9612536   1% /opt</div><div class="line">tmpfs                   199528       0    199528   0% /run/user/0</div><div class="line">overlay               52403200 3211932  49191268   7% /var/lib/docker/overlay/a1adbe925183f6969aec2a38c9505e2bc7b9184ddeb362f2c6ad4e07d0727164/merged</div><div class="line">shm                      65536       0     65536   0% /var/lib/docker/containers/58818b40586e230715df416779ec23799000616b0f0c09686ca1ccc9a8a4401d/shm</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl status ntpd|grep PID</span></div><div class="line"> Main PID: 1942 (ntpd)</div><div class="line">[root@kevinzou ~]<span class="comment"># grep overlay /proc/1942/mounts</span></div><div class="line">/dev/mapper/vg0-root /var/lib/docker/overlay xfs rw,seclabel,relatime,attr2,inode64,noquota 0 0</div></pre></td></tr></table></figure>
<p> 和devicemapper 方式一样，先启动ntpd服务，后启动docker服务并创建container，不会有任何问题。</p>
<ul>
<li>重启ntpd服务，激活bug</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># systemctl restart ntpd</span></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl status ntpd|grep PID</span></div><div class="line"> Main PID: 2255 (ntpd)</div><div class="line">[root@kevinzou ~]<span class="comment"># grep overlay /proc/2255/mounts</span></div><div class="line">/dev/mapper/vg0-root /var/lib/docker/overlay xfs rw,seclabel,relatime,attr2,inode64,noquota 0 0</div><div class="line">overlay /var/lib/docker/overlay/a1adbe925183f6969aec2a38c9505e2bc7b9184ddeb362f2c6ad4e07d0727164/merged overlay rw,seclabel,relatime,lowerdir=/var/lib/docker/overlay/5b1bd094a587e8b891dcadec0ccbeb9feb8afed7880cfd62831f01105b92df2d/root,upperdir=/var/lib/docker/overlay/a1adbe925183f6969aec2a38c9505e2bc7b9184ddeb362f2c6ad4e07d0727164/upper,workdir=/var/lib/docker/overlay/a1adbe925183f6969aec2a38c9505e2bc7b9184ddeb362f2c6ad4e07d0727164/work 0 0</div><div class="line"></div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker rm -f $(docker ps -q)</span></div><div class="line">Error response from daemon: driver <span class="string">"overlay"</span> failed to remove root filesystem <span class="keyword">for</span> 58818b40586e230715df416779ec23799000616b0f0c09686ca1ccc9a8a4401d: remove /var/lib/docker/overlay/a1adbe925183f6969aec2a38c9505e2bc7b9184ddeb362f2c6ad4e07d0727164/merged: device or resource busy</div><div class="line"></div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># docker ps</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div></pre></td></tr></table></figure>
<ul>
<li>修改<code>/usr/lib/systemd/system/docker.service</code>配置文件<code>[Service]</code>段中加入<code>MountFlags=slave</code>，解决Bug</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># systemctl stop docker</span></div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># vi /usr/lib/systemd/system/docker.service</span></div><div class="line">[Unit]</div><div class="line">Description=Docker Application Container Engine</div><div class="line">Documentation=https://docs.docker.com</div><div class="line">After=network-online.target firewalld.service</div><div class="line">Wants=network-online.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></div><div class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></div><div class="line"><span class="comment"># for containers run by docker</span></div><div class="line">ExecStart=/usr/bin/dockerd</div><div class="line">ExecReload=/bin/<span class="built_in">kill</span> <span class="_">-s</span> HUP <span class="variable">$MAINPID</span></div><div class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></div><div class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></div><div class="line">LimitNOFILE=infinity</div><div class="line">LimitNPROC=infinity</div><div class="line">LimitCORE=infinity</div><div class="line"><span class="comment"># Uncomment TasksMax if your systemd version supports it.</span></div><div class="line"><span class="comment"># Only systemd 226 and above support this version.</span></div><div class="line"><span class="comment">#TasksMax=infinity</span></div><div class="line">TimeoutStartSec=0</div><div class="line"><span class="comment"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></div><div class="line">Delegate=yes</div><div class="line"><span class="comment"># kill only the docker process, not all processes in the cgroup</span></div><div class="line">KillMode=process</div><div class="line"><span class="comment"># restart the docker process if it exits prematurely</span></div><div class="line">Restart=on-failure</div><div class="line">StartLimitBurst=3</div><div class="line">StartLimitInterval=60s</div><div class="line"></div><div class="line">MountFlags=slave</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl daemon-reload</span></div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl start docker</span></div><div class="line"></div><div class="line"></div><div class="line">[root@kevinzou ~]<span class="comment"># lsns</span></div><div class="line">        NS TYPE  NPROCS   PID USER COMMAND</div><div class="line">4026531836 pid      207     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531837 user     207     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531838 uts      207     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531839 ipc      207     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531840 mnt      199     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026531856 mnt        1    17 root kdevtmpfs</div><div class="line">4026531956 net      207     1 root /usr/lib/systemd/systemd --switched-root --system --deserialize 21</div><div class="line">4026532462 mnt        1   587 root /usr/lib/systemd/systemd-udevd</div><div class="line">4026532463 mnt        1   774 root /usr/bin/vmtoolsd</div><div class="line">4026532547 mnt        2   802 root /usr/sbin/NetworkManager --no-daemon</div><div class="line">4026532548 mnt        1  2255 ntp  /usr/sbin/ntpd -u ntp:ntp -g</div><div class="line">4026532553 mnt        2  2373 root /usr/bin/dockerd</div></pre></td></tr></table></figure>
<ul>
<li>测试修改后不会激活Bug</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@kevinzou ~]<span class="comment"># docker run -d busybox /bin/sh -c "while : ; do sleep 1000 ; done"</span></div><div class="line">be96dd4a7f8bf51f36a5ba18b007bf4f7dd2245c805ad42f60fd3017f56bbe2f</div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl restart ntpd</span></div><div class="line">[root@kevinzou ~]<span class="comment"># df</span></div><div class="line">Filesystem           1K-blocks    Used Available Use% Mounted on</div><div class="line">/dev/mapper/vg0-root  52403200 3212008  49191192   7% /</div><div class="line">devtmpfs                986864       0    986864   0% /dev</div><div class="line">tmpfs                   997636       0    997636   0% /dev/shm</div><div class="line">tmpfs                   997636     780    996856   1% /run</div><div class="line">tmpfs                   997636       0    997636   0% /sys/fs/cgroup</div><div class="line">/dev/sda5             20971520   16928  18856704   1% /home</div><div class="line">/dev/sda1               201380  164836     36544  82% /boot</div><div class="line">/dev/mapper/vg0-opt   10190100   36892   9612536   1% /opt</div><div class="line">tmpfs                   199528       0    199528   0% /run/user/0</div><div class="line">[root@kevinzou ~]<span class="comment"># systemctl status ntpd|grep PID</span></div><div class="line"> Main PID: 2544 (ntpd)</div><div class="line">[root@kevinzou ~]<span class="comment"># grep overlay /proc/2544/mounts</span></div><div class="line">[root@kevinzou ~]<span class="comment"># docker rm -f $(docker ps -q)</span></div><div class="line">be96dd4a7f8b</div></pre></td></tr></table></figure>
<h2 id="其他概念"><a href="#其他概念" class="headerlink" title="其他概念"></a>其他概念</h2><p>Systemd PrivateTmp :   True/yes  </p>
<p>使用独立的挂接空间运行服务，默认执行时继承系统全局挂接空间。</p>
<p>Systemd MountFlags： share/slave/private</p>
<p>设置文件系统的挂载传递标记，可设为 <code>shared</code>, <code>slave</code>, <code>private</code> 之一。 这些标记控制着文件系统挂载点的挂载和卸载动作如何在主机与容器之间传递。  <code>shared</code> 表示 挂载和卸载将会在主机和容器之间同步(双向可见)； <code>slave</code>表示容器内的挂载和卸载不会传递到主机， 但主机中挂载的文件系统依然对容器内的进程可见。 <code>private</code> 表示主机的挂载和卸载不会传递到容器， 同时容器中的挂载亦不会传递到主机中(双向不可见)。 本选项的默认值一般是 <code>shared</code> ， 但如果使用了<code>PrivateTmp=</code>, <code>PrivateDevices=</code>, <code>ProtectSystem=</code>, <code>ProtectHome=</code>, <code>ReadOnlyPaths=</code>, <code>InaccessiblePaths=</code>, <code>ReadWritePaths=</code>选项之一， 那么本选项的默认值将会 自动从 <code>slave</code> 降级到 <code>private</code> ， 因为这些选项要求挂载和卸载必须不能从容器传递到主机。 </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://access.redhat.com/errata/RHBA-2017:1620" target="_blank" rel="external">https://access.redhat.com/errata/RHBA-2017:1620</a></p>
<p><a href="https://github.com/moby/moby/issues/22260" target="_blank" rel="external">https://github.com/moby/moby/issues/22260</a></p>
<p><a href="https://github.com/moby/moby/issues/27381" target="_blank" rel="external">https://github.com/moby/moby/issues/27381</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/09/09/net-nf-conntrack-max-设置异常问题/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/09/net-nf-conntrack-max-设置异常问题/" itemprop="url">
                  net.nf_conntrack_max 设置异常问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-09T13:04:49+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/09/09/net-nf-conntrack-max-设置异常问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/09/net-nf-conntrack-max-设置异常问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="故障原因"><a href="#故障原因" class="headerlink" title="故障原因"></a>故障原因</h2><ol>
<li>内核参数 net.nf_conntrack_max 系统默认值为”65536”，当nf_conntrack模块被装置且服务器上连接超过这个设定的值时，系统会主动丢掉新连接包，直到连接小于此设置值才会恢复。同时内核参数“net.netfilter.nf_conntrack_tcp_timeout_established”系统默认值为”432000”，代表nf_conntrack的TCP连接记录时间默认是5天，致使nf_conntrack的值减不下来，丢包持续时间长。</li>
<li>nf_conntrack模块在首次装载或重新装载时，内核参数net.nf_conntrack_max会重新设置为默认值“65536”，并且不会调用sysctl设置为我们的预设值。</li>
<li>触发nf_conntrack模块首次装载比较隐蔽，任何调用IPtable NAT功能的操作都会触发。当系统没有挂载nf_conntrack模块时，iptables 相关命令（iptables -L -t nat）就成触发nf_conntrack模块装置，致使net.nf_conntrack_max 重设为65536。</li>
<li>触发nf_conntrack模块重新装载的操作很多，CentOS6 中“service iptables restart”，CentOS7中“systemctl restart firewalld”都会触发设置重置，致使net.nf_conntrack_max 重设为65536。</li>
</ol>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol>
<li>通过系统初始化脚本创建配置文件”/etc/modprobe.d/nf_conntrack.conf”, 内容为“options nf_conntrack hashsize=262144”，通过nf_conntrack模块挂接参数”hashsize”设置“net.nf_conntrack_max=2097152”（nf_conntrack_max=hashsize*8），保证后续新初始化服务器配置正确。</li>
<li>通过自动化部署工具全网推送配置文件”/etc/modprobe.d/nf_conntrack.conf”, 内容为“options nf_conntrack hashsize=262144”，保证nf_conntrack模块在首次装载或重新装载时“net.nf_conntrack_max”内核参数设置为我们预期的“2097152”</li>
<li>更新系统初始化脚本，设置“net.netfilter.nf_conntrack_tcp_timeout_established=1800”，减少nf_conntrack的TCP连接记录时间。</li>
<li>如果并不需要nf_conntrack及其相关模块可以在/etc/modprobe.d目录新建文件blacklist.conf ,文件中加入：<code>install nf_conntrack /bin/false</code>          这样做的副作用是无法再使用Iptables NAT相关功能。</li>
</ol>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><ul>
<li>nf_conntrack模块在首次装载时初始化默认值为”65536”</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># systemctl  stop firewalld</span></div><div class="line">[root@localhost ~]<span class="comment"># lsmod |grep nf_conntrack</span></div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">[root@localhost ~]<span class="comment"># iptables -L -t nat</span></div><div class="line">Chain PREROUTING (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line">[root@localhost ~]<span class="comment"># lsmod |grep nf_conntrack</span></div><div class="line">nf_conntrack_ipv4      19108  1</div><div class="line">nf_defrag_ipv4         12729  1 nf_conntrack_ipv4</div><div class="line">nf_conntrack          111302  3 nf_nat,nf_nat_ipv4,nf_conntrack_ipv4</div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_buckets = 16384</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_count = 1</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_expect_max = 256</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_helper = 1</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_max = 65536</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 432000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_timestamp = 0</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.nf_conntrack_max = 65536</div></pre></td></tr></table></figure>
<ul>
<li>设置“net.nf_conntrack_max = 2097152” ，重启“firewalld”服务，”nf_conntrack_max”重新被初始化为”65536”</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># systemctl start firewalld</span></div><div class="line">[root@localhost ~]<span class="comment"># sysctl net.nf_conntrack_max=2097152</span></div><div class="line">net.nf_conntrack_max = 2097152</div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_buckets = 16384</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_count = 1</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_expect_max = 256</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_helper = 1</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_max = 2097152</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 432000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_timestamp = 0</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.nf_conntrack_max = 2097152</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl restart firewalld</span></div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_buckets = 16384</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_count = 1</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_expect_max = 256</div><div class="line">net.netfilter.nf_conntrack_frag6_high_thresh = 4194304</div><div class="line">net.netfilter.nf_conntrack_frag6_low_thresh = 3145728</div><div class="line">net.netfilter.nf_conntrack_frag6_timeout = 60</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_helper = 1</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_icmpv6_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_max = 65536</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 432000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_timestamp = 0</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.nf_conntrack_max = 65536</div></pre></td></tr></table></figure>
<ul>
<li>设置配置文件”/etc/modprobe.d/nf_conntrack.conf”, 内容为“options nf_conntrack hashsize=262144”,保持“net.nf_conntrack_max =2097152”</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat /etc/modprobe.d/nf_conntrack.conf</span></div><div class="line">options nf_conntrack hashsize=262144</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl  stop firewalld</span></div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># iptables -L -t nat</span></div><div class="line">Chain PREROUTING (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_buckets = 262144</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_count = 1</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_expect_max = 4096</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_helper = 1</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_max = 2097152</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 432000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_timestamp = 0</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.nf_conntrack_max = 2097152</div><div class="line"></div><div class="line">[root@localhost ~]<span class="comment"># systemctl  restart firewalld</span></div><div class="line">[root@localhost ~]<span class="comment"># sysctl -a |grep nf_conntrack</span></div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_buckets = 262144</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_count = 1</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_expect_max = 4096</div><div class="line">net.netfilter.nf_conntrack_frag6_high_thresh = 4194304</div><div class="line">net.netfilter.nf_conntrack_frag6_low_thresh = 3145728</div><div class="line">net.netfilter.nf_conntrack_frag6_timeout = 60</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_helper = 1</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_icmpv6_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_max = 2097152</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 432000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_timestamp = 0</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.nf_conntrack_max = 2097152</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/04/11/Linux-系统使用规范/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/11/Linux-系统使用规范/" itemprop="url">
                  Linux 系统使用规范
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-11T22:58:22+08:00">
                2017-04-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/04/11/Linux-系统使用规范/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/11/Linux-系统使用规范/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p><strong>不要修改系统级配置文件，请添加自定义配置文件到系统级配置目录中。</strong></p>
<p>例如：一般在配置文件的同级目录下都会有一个<code>配置文件名.d</code>的配置目录，它们是为了防止多用户多服务环境配置冲突问题。</p>
<p>​       proc 内核参数配置，不要直接修改配置文件<code>/etc/sysctl.conf</code>，应该以业务或服务名命名配置文件（如 <code>99-app-sysctl.conf</code>)，然后将其放入/etc/sysctl.d目录。</p>
<p>​       同理配置ulimit也一样 ,  请不要修改<code>/etc/security/limits.conf</code> 配置文件，而是应该以业务或服务名命名配置文件（如 <code>99-app-limits.conf</code>)，然后将其放入<code>/etc/security/limits.d/</code>目录。</p>
<p>​       同理配置全局Shell的环境变量，请不要修改/etc/profile或/etc/bashrc文件，而是应该以业务或单独命名配置文件（如eleme.sh),然后将其放置在/etc/profile.d目录。</p>
</li>
<li><p><strong>最小范围定义环境变量 (Less better than more !)</strong></p>
<p>例如：程序启动需要的环境变量，写在程序启动脚本里。</p>
<p>​            用户需要的环境变量，写在用户的<code>~/.bashrc</code>里。</p>
<p>​            需要多个程序公用的环境变量，写在独立的文件中，然后使用<code>source</code>命令带入程序启动脚本里。</p>
<p>​        如果变量不可变，请用<code>readonly</code>修饰它。</p>
<p>​            如果变量需要子进程或子shell继承，请用<code>export</code>修饰它。</p>
</li>
<li><p><strong>cp 命令好过mv命令，mv命令好过rm命令。</strong></p>
<p>例如：如果需要把文件放在新的位置，请先确认是否需要删除原有文件，如果不需要删除，请使用cp命令。如果需要删除原有文件，将其使用mv改名为<code>filename.bak-$(date %F-%T)</code>。目前的系统磁盘远远大于我们需要的空间量，保存一个文件的原始位置备份，有助于我们快速恢复。</p>
</li>
<li><p><strong>创建计划任务时（cron），请为你的计划任务设置优先级（nice）。</strong></p>
<p>例如：计划任务均为后台执行程序，运行过程中会与其他运行任务争抢资源，如果你不想由于执行计划任务导致此设备上的其他任务运行缓慢，请在命令前加上<code>nice -n 10</code>，没有其他任务运行时它运行飞快，有其他任务运行时它会让出资源。</p>
</li>
<li><p><strong>创建计划任务时（cron），请注意命令路径问题，请使用全路径运行程序。</strong></p>
<p>例如：<code>crontab -e -u USERNAME</code>时，默认没有环境变量设置，请自定义PATH等变量​</p>
</li>
<li><p><strong>当你程序打不开、写不了、无法创建文件和目录时，请检查其父目录权限。</strong></p>
<p>例如： <code>/var/log</code>目录权限<code>root.root 755</code>，你要想让你的程序写日志进去，请自行创建<code>/var/log/程序名</code>目录，保证运行程序的用户有写入的权限。</p>
</li>
<li><p><strong>命令敲完回车前请确认输入是否正确，命令执行完请确认命令回显。</strong></p>
<p>例如：如果你的网络设置命令执行错误，直接会导致网络断开，你会被堡垒机踢出或冻结输入框。这时应该第一时间联系基础运维，他们还有IPMI控制卡连接方式帮你救回来。</p>
</li>
<li><p><strong>文件名和目录区分大小写，请保持所有名称都是小写字母</strong></p>
</li>
<li><p><strong>清空日志文件的正确方法是<code>&gt;./logfile.log</code>，而不是<code>rm -rf ./logfile.log</code></strong></p>
<p>​</p>
<p>​</p>
</li>
</ol>
<p>   ​</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/04/10/ethtool-软件包定制/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/10/ethtool-软件包定制/" itemprop="url">
                  ethtool 软件包定制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-10T16:55:33+08:00">
                2017-04-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/04/10/ethtool-软件包定制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/10/ethtool-软件包定制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于CentOS 6 默认自带的ethtool工具版本为3.8 ，不支持intel 万兆光纤卡的光纤衰减显示，所有需要定制新版本的ethtool工具。</p>
<ol>
<li><p>确认安装rpm-build软件包</p>
</li>
<li><p>本地创建rpmbuild所需目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p ~/rpmbuild/&#123;BUILD,RPMS,SOURCES,SPECS,SRPMS&#125;</span></div></pre></td></tr></table></figure>
</li>
<li><p>在~/rpmbuild/SPECS目录下创建spec文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ~/rpmbuild/SPECS/ethtool.spec</span></div><div class="line"></div><div class="line">Name:		ethtool</div><div class="line">Epoch:		3</div><div class="line">Version:	4.10</div><div class="line">Release:	1%&#123;?dist&#125;</div><div class="line">Summary:	Settings tool <span class="keyword">for</span> Ethernet NICs</div><div class="line"></div><div class="line">License:	GPLv2</div><div class="line">Group:		Applications/System</div><div class="line">URL:		http://ftp.kernel.org/pub/software/network/%&#123;name&#125;/</div><div class="line"></div><div class="line"><span class="comment"># Source0 指定ethtool源代码文件下载路径</span></div><div class="line">Source0:	https://www.kernel.org/pub/software/network/ethtool/ethtool-4.10.tar.xz</div><div class="line">BuildRequires:	automake, autoconf</div><div class="line"><span class="comment">#Conflicts:      filesystem &lt; 3</span></div><div class="line"></div><div class="line">%description</div><div class="line">This utility allows querying and changing settings such as speed,</div><div class="line">port, auto-negotiation, PCI locations and checksum offload on many</div><div class="line">network devices, especially of Ethernet devices.</div><div class="line"></div><div class="line">%prep</div><div class="line">%setup -q -n %&#123;name&#125;-%&#123;version&#125;%&#123;?pre&#125;</div><div class="line"></div><div class="line">%build</div><div class="line">%configure --sbindir=/sbin</div><div class="line">make %&#123;?_smp_mflags&#125;</div><div class="line"></div><div class="line">%install</div><div class="line">rm -rf %&#123;buildroot&#125;</div><div class="line">make DESTDIR=%&#123;buildroot&#125; INSTALL=<span class="string">'install -p'</span> install</div><div class="line"></div><div class="line"><span class="comment"># Some legacy support for scripts etc. out there</span></div><div class="line">mkdir -p %&#123;buildroot&#125;%&#123;_sbindir&#125;</div><div class="line">ln -sf ../../sbin/%&#123;name&#125; %&#123;buildroot&#125;%&#123;_sbindir&#125;/%&#123;name&#125;</div><div class="line"></div><div class="line">%clean</div><div class="line">rm -rf %&#123;buildroot&#125;</div><div class="line"></div><div class="line">%files</div><div class="line">%defattr(-,root,root,-)</div><div class="line">%doc AUTHORS ChangeLog* COPYING LICENSE NEWS README</div><div class="line">/sbin/%&#123;name&#125;</div><div class="line">%&#123;_sbindir&#125;/%&#123;name&#125;</div><div class="line">%&#123;_mandir&#125;/man8/%&#123;name&#125;.8*</div></pre></td></tr></table></figure>
</li>
<li><p>编译创建ethtool rpm包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rpmbuild -ba ~/rpmbuild/SPECS/ethtool.spec</span></div></pre></td></tr></table></figure>
</li>
<li><p>编译好的ethtool rpm文件在<code>~/rpmbuild/RPMS/</code>目录下。</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/03/13/虚拟机故障定位过程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/13/虚拟机故障定位过程/" itemprop="url">
                  虚拟机故障定位过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-13T10:34:03+08:00">
                2017-03-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/13/虚拟机故障定位过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/13/虚拟机故障定位过程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近一次虚拟机运行故障，记录一下分析思路和过程。</p>
<p>首先是现象，故障事件描述如下：</p>
<p>2017年3月7日15：40左右，业务报告“虚拟机N”上的服务没有响应了，业务运维发现此KVM虚拟机无法登陆，所有通知基础运维并从新启动了这台KVM虚拟机。</p>
<p>虚拟机重启后业务逐步恢复，需要分析KVM无法登陆的原因。</p>
<p>问题分析过程：</p>
<ol>
<li>首先登陆虚拟机N和其宿主机H，将其上的/var/log/messages日志文件复制到/tmp/message目录下，分析日志内容。</li>
<li>在虚拟机N上的messages文件中发现大量干扰日志，格式类似如下内容</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2017-03-07 03:28:40.240 info watchdog.lnx[16616]: INFO 2017-03-07 03:28:40 watchdog.go:55 Watchdog Sam<span class="string">'s alive</span></div><div class="line">2017-03-07 03:28:42.240 info watchdog.lnx[16616]: INFO 2017-03-07 03:28:42 watchdog.go:55 Watchdog Sam's alive</div><div class="line">2017-03-07 03:28:44.240 info watchdog.lnx[16616]: INFO 2017-03-07 03:28:44 watchdog.go:55 Watchdog Sam<span class="string">'s alive</span></div><div class="line">2017-03-07 03:28:46.240 info watchdog.lnx[16616]: INFO 2017-03-07 03:28:46 watchdog.go:55 Watchdog Sam's alive</div></pre></td></tr></table></figure>
<p>   所以使用grep将干扰日志项过滤，并显示日志行号方便定位：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat -nA messages | grep -v watchdog.go |less</span></div></pre></td></tr></table></figure>
<p>  发现确切的虚拟机故障时间和重启成功时间，相关内容日志如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">18473  2017-03-07 13:30:01.184 info systemd[1]: Removed slice user-0.slice.$</div><div class="line">18474  2017-03-07 13:30:01.184 info systemd[1]: Stopping user-0.slice.$</div><div class="line">18711  ^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@2017-03-07 15:45:26.028 info rsyslogd: [origin software=<span class="string">"rsyslogd"</span> swVersion=<span class="string">"7.4.7"</span> x-pid=<span class="string">"533"</span> x-info=<span class="string">"http://www.rsyslog.com"</span>] start$</div><div class="line">18712  2017-03-07 15:45:25.971 err rsyslogd-2181: <span class="variable">$WorkDirectory</span>: /var/spool/rsyslog can not be accessed, probably does not exist - directive ignored [try http://www.rsyslog.com/e/2181 ]$</div><div class="line">18713  2017-03-07 15:45:26.017 err rsyslogd-2307: warning: ~ action is deprecated, consider using the <span class="string">'stop'</span> statement instead [try http://www.rsyslog.com/e/2307 ]$</div></pre></td></tr></table></figure>
<p>   其中空格分割的第一部分为message文件中条目的原始行号。我们为了快速定位问题时间，使用了过滤干扰项，但分析故障时可能还需要查看原始文件，这个原始行号就十分重要了。</p>
<ol>
<li>在检查日志虚拟机N日志时，我们定位到了13：37后此虚拟机出现了故障，然后到15：45我们重新启动了这个虚拟机：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">2017-03-07 13:37:52.240 info watchdog.lnx[16616]: INFO 2017-03-07 13:37:52 watchdog.go:55 Watchdog Sam<span class="string">'s alive</span></div><div class="line">^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@</div><div class="line">^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@</div><div class="line">^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@</div><div class="line">^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@</div><div class="line">^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@2017-03-07 15:45:26.028 info rsyslogd: [origin software="rsyslogd" swVersion="7.4.7" x-pid="533" x-info="http://www.rsyslog.com"] start</div><div class="line">2017-03-07 15:45:25.971 err rsyslogd-2181: $WorkDirectory: /var/spool/rsyslog can not be accessed, probably does not exist - directive ignored [try http://www.rsyslog.com/e/2181 ]</div><div class="line">2017-03-07 15:45:26.017 err rsyslogd-2307: warning: ~ action is deprecated, consider using the 'stop<span class="string">' statement instead [try http://www.rsyslog.com/e/2307 ]</span></div></pre></td></tr></table></figure>
<p>   因此，我们需要定位宿主机H上相同时间段，并查看在此时间段内出现和什么故障或报出了什么错误。</p>
<p>   我们在H上的message日志文件中发现了同时段报出的错误日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Mar  7 13:38:04 H kernel: EPT: Misconfiguration.</div><div class="line">Mar  7 13:38:04 H kernel: EPT: GPA: 0x108ba4538</div><div class="line">Mar  7 13:38:04 H kernel: ept_misconfig_inspect_spte: spte 0x84c236107 level 4</div><div class="line">Mar  7 13:38:04 H kernel: ept_misconfig_inspect_spte: spte 0x10515c7107 level 3</div><div class="line">Mar  7 13:38:04 H kernel: ept_misconfig_inspect_spte: spte 0xde4657107 level 2</div><div class="line">Mar  7 13:38:04 H kernel: ept_misconfig_inspect_spte: spte 0x1028125d77 level 1</div></pre></td></tr></table></figure>
<p>   其中关键字段和术语：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>EPT</td>
<td>Extended Page Table</td>
</tr>
<tr>
<td>GPA</td>
<td>Guest Physical address</td>
</tr>
</tbody>
</table>
<p>​    可以看出此错误和KVM虚拟化有关。</p>
<p>​    进一步查看当时的zstack-agent日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2017-03-07 13:38:04,415 DEBUG [vm_plugin] ignore event[Suspended] of the vm[uuid:2c521dfe81b44151b25ff8e4b852fa4e]</div><div class="line">2017-03-07 15:45:08,554 DEBUG [vm_plugin] ignore event[Stopped] <span class="keyword">for</span> the vm[uuid:2c521dfe81b44151b25ff8e4b852fa4e], this operation is from ZStack itself</div></pre></td></tr></table></figure>
<p>   发现有虚拟机挂起！</p>
<ol>
<li>综上，可以断定是由于虚拟机挂起导致的问题。那么为什么会挂起呢？我们借助google可以查找关键字</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kernel: EPT: Misconfiguration.</div></pre></td></tr></table></figure>
<p>可以找到相关的条目，其中有RedHat 知识库中的条目：</p>
<p><a href="https://access.redhat.com/solutions/1758133" target="_blank" rel="external">https://access.redhat.com/solutions/1758133</a></p>
<p>此问题是一个Bug，RedHat知识库描述如下：</p>
<blockquote>
<p>Root Cause</p>
<p>A MMIO Page Fault related bug in KVM causes this. This is a Hypervisor side bug and any VM OS might hit it.</p>
<p>The probability of hitting it appears to be quite low (many VMs running for days).</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">MMIO</td>
<td style="text-align:left">Memory-mapped I/O</td>
</tr>
</tbody>
</table>
<p> 这不是一个常见的错误，RedHat 建议升级内核解决这个Bug：</p>
<blockquote>
<p>Resolution</p>
<ul>
<li>RHEL 7.3: Upgrade to <code>kernel-3.10.0-514.el7</code> from <a href="https://rhn.redhat.com/errata/RHSA-2016-2574.html" target="_blank" rel="external">Errata RHSA-2016:2574</a> or later</li>
<li>RHEL 7.2.z: Upgrade to <code>kernel-3.10.0-327.3.1.el7</code> from <a href="https://rhn.redhat.com/errata/RHSA-2015-2552.html" target="_blank" rel="external">Errata RHSA-2015:2552</a> or later</li>
</ul>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/01/12/Python-librbd-创建RBD-image的三种方式/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/Python-librbd-创建RBD-image的三种方式/" itemprop="url">
                  Python librbd 创建RBD image的三种方式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-12T10:47:08+08:00">
                2017-01-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/12/Python-librbd-创建RBD-image的三种方式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/12/Python-librbd-创建RBD-image的三种方式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装python-ceph库"><a href="#安装python-ceph库" class="headerlink" title="安装python-ceph库"></a>安装python-ceph库</h1><p>Ceph官方提供Python库来访问RBD，通过以下命令可以安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum install python-rbd python-rados -y</div></pre></td></tr></table></figure>
<h1 id="创建-Image"><a href="#创建-Image" class="headerlink" title="创建 Image"></a>创建 Image</h1><p>有三种可选的写法，个人推荐第三种</p>
<h2 id="简单流程"><a href="#简单流程" class="headerlink" title="简单流程"></a>简单流程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados</div><div class="line"><span class="keyword">import</span> rbd</div><div class="line"></div><div class="line">cluster = rados.Rados(conffile=<span class="string">'/etc/ceph/ceph.conf'</span>)</div><div class="line">cluster.connect()</div><div class="line">ioctx = cluster.open_ioctx(<span class="string">'rbd'</span>)</div><div class="line"></div><div class="line">rbd_inst = rbd.RBD()</div><div class="line">size = <span class="number">1024</span>**<span class="number">3</span></div><div class="line">image_name = <span class="string">"test_image"</span></div><div class="line">rbd_inst.create(ioctx, image_name, size)</div><div class="line"></div><div class="line">image = rbd.Image(ioctx, image_name)</div><div class="line">data = <span class="string">'foo'</span> * <span class="number">200</span></div><div class="line">image.write(data, <span class="number">0</span>)</div><div class="line"></div><div class="line">image.close()</div><div class="line">ioctx.close()</div><div class="line">cluster.shutdown()</div></pre></td></tr></table></figure>
<h2 id="Try-Finally-方式"><a href="#Try-Finally-方式" class="headerlink" title="Try-Finally 方式"></a>Try-Finally 方式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados</div><div class="line"><span class="keyword">import</span> rbd</div><div class="line"></div><div class="line">cluster = rados.Rados(conffile=<span class="string">'/etc/ceph/ceph.conf'</span>)</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    ioctx = cluster.open_ioctx(<span class="string">'rbd'</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        rbd_inst = rbd.RBD()</div><div class="line">        size = <span class="number">1024</span>**<span class="number">3</span></div><div class="line">    image_name = <span class="string">"test_image"</span></div><div class="line">        rbd_inst.create(ioctx, image_name, size)</div><div class="line">        image = rbd.Image(ioctx, image_name)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = <span class="string">'foo'</span> * <span class="number">200</span></div><div class="line">            image.write(data, <span class="number">0</span>)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            image.close()</div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        ioctx.close()</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">    cluster.shutdown()</div></pre></td></tr></table></figure>
<h2 id="With-As-方式"><a href="#With-As-方式" class="headerlink" title="With-As 方式"></a>With-As 方式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> rados.Rados(conffile=<span class="string">'/etc/ceph/ceph.conf'</span>) <span class="keyword">as</span> cluster:</div><div class="line">    <span class="keyword">with</span> cluster.open_ioctx(<span class="string">'rbd'</span>) <span class="keyword">as</span> ioctx:</div><div class="line">        rbd_inst = rbd.RBD()</div><div class="line">        size = <span class="number">1024</span>**<span class="number">3</span></div><div class="line">    image_name = <span class="string">"test_image"</span></div><div class="line">        rbd_inst.create(ioctx, image_name, size)</div><div class="line">        <span class="keyword">with</span> rbd.Image(ioctx, image_name) <span class="keyword">as</span> image:</div><div class="line">            data = <span class="string">'foo'</span> * <span class="number">200</span></div><div class="line">            image.write(data, <span class="number">0</span>)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/01/09/在CentOS7-VPS-上通过Docker-配置科学上网/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/在CentOS7-VPS-上通过Docker-配置科学上网/" itemprop="url">
                  在CentOS7 VPS 上通过Docker 配置科学上网
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-09T15:27:11+08:00">
                2017-01-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/09/在CentOS7-VPS-上通过Docker-配置科学上网/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/09/在CentOS7-VPS-上通过Docker-配置科学上网/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>科学上网已经成为天朝 IT 从业人员必备的工作和生活技能。如果你不会就和时代脱节了！</p>
<p>如果你和我一样有自己的VPS，那么你应该自建VPN用来科学上网，这样更加自由！</p>
<p>配置VPN的方法很多，也比较复杂，有没有简单易行的如来神掌呢？当然有！如果你的VPS是Linux系统，并且比较现代，发行版不重要，内核版本很重要！因为我们的如来神掌是基于Docker的，所有你需要3.10以上的内核，然后装上Docker环境。</p>
<p>如何安装和配置Docker ，你可以参看我的文档<a href="https://github.com/kissingwolf/docker-basic" target="_blank" rel="external">docker 基础</a> 。我这里就不重复了。</p>
<p>安装好Docker后，接下来所有的配置和启动都是一个命令和一些参数就可以搞定。你改改密码就好了！</p>
<p>首先记得配好你本地的防火墙和SElinux ，如何你不会，看看<a href="https://github.com/Uplooking-SH/UP100_ule" target="_blank" rel="external">尚观基础课程</a> 。</p>
<p>首先配置pptp vpn ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">local_path_to_chap_secrets=./chap-secrets</div><div class="line">docker run -d --privileged --net=host -p 1723:1723 -v \ $&#123;local_path_to_chap_secrets&#125;:/etc/ppp/chap-secrets mobtitude/vpn-pptp</div></pre></td></tr></table></figure>
<p><code>chap-secrets</code>内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kevinzou * ooxx9527FUCKGFW *</div></pre></td></tr></table></figure>
<p>接下来是ipsec vpn：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">My_PASSWD=&quot;ooxx9527FUCKGFW“</div><div class="line">My_NAME=&quot;kevinzou&quot;</div><div class="line">My_PSK=&quot;F5bF4848B7&quot;</div><div class="line">docker run -d -p 500:500/udp -p 4500:4500/udp -p 1701:1701/udp --privileged --restart=always -e VPN_PASSWORD=$My_PASSWD  -e VPN_USER=$My_NAME -e VPN_PSK=$My_PSK philplckthun/strongswan</div></pre></td></tr></table></figure>
<p>如果pptp和ipsec还满足不了你的需求，可以考虑shadowsocks：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">SSPASSWORD=&quot;ooxx9527FUCKGFW&quot;</div><div class="line">docker run --restart=always -d -p 12356:1984 oddrationale/docker-shadowsocks -s 0.0.0.0 -p 1984 -k $SSPASSWORD -m aes-256-cfb</div></pre></td></tr></table></figure>
<p>具体参数就不在这里细说了，PPTP方便简单，windows、Linux 和较老的mac都能用。IPSEC 主要是支持ios 10和macOS 10.12。 shadowsocks 支持<code>自动代理模式</code>比较省流量， 并且访问国内也快。</p>
<p>好了，祝玩的开心。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2017/01/02/练习的心态-如何培养耐心、专注和自律/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/02/练习的心态-如何培养耐心、专注和自律/" itemprop="url">
                  练习的心态-如何培养耐心、专注和自律
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-02T20:42:39+08:00">
                2017-01-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/02/练习的心态-如何培养耐心、专注和自律/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/02/练习的心态-如何培养耐心、专注和自律/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="学习开始"><a href="#学习开始" class="headerlink" title="学习开始"></a>学习开始</h2><blockquote>
<p>实现目标的方法和目标本身同等重要。</p>
<p>人生是一段路程，不是一个目的地。</p>
</blockquote>
<p>人生就是漫长的练习。</p>
<p>所谓练习，就是怀着实现某个特定目标的有意的意识和意图，来反复参加某项活动。</p>
<blockquote>
<p>人生中值得去做的每一件事情，都需要练习。事实上，人生本身只不过是一个漫长的练习过程，是一种永无止境的优化各种行为的努力。当你懂得了练习的正确原理，学习某些新事物的任务将变成一种没有压力的愉快与平和的体验，变成一个适合你生活中各种领域的过程，并且促成你对生活中所有的艰辛与痛苦采用合适的视角来观察。</p>
</blockquote>
<h2 id="以过程为导向，不以结果为导向"><a href="#以过程为导向，不以结果为导向" class="headerlink" title="以过程为导向，不以结果为导向"></a>以过程为导向，不以结果为导向</h2><blockquote>
<p>耐心与自律的问题是，要培养它们其中任何一个，就要同时具备它们两个。</p>
</blockquote>
<p>本着达到某个特定目标的意图，刻意地、反复地参与练习过程。</p>
<ul>
<li>让自己始终以过程为导向。</li>
<li>重点关注当前。</li>
<li>将过程确定为目标，并且运用总目标为船舵，以指引自己的努力。</li>
<li>对自己想要做的事情刻意的训练，带着意图训练，并且自始至终清醒的知道这种意图。</li>
</ul>
<h2 id="关键是视角"><a href="#关键是视角" class="headerlink" title="关键是视角"></a>关键是视角</h2><blockquote>
<p>当我们试图理解自己以及我们对人生中各种努力的痛苦挣扎时，可以通过观察一朵鲜花来找到平和。问你自己：一朵鲜花的生命，从撒下种子到完全盛开，在什么时候刻意达到完美？</p>
</blockquote>
<h2 id="培养期望的习惯"><a href="#培养期望的习惯" class="headerlink" title="培养期望的习惯"></a>培养期望的习惯</h2><blockquote>
<p>习惯是学来的</p>
</blockquote>
<h2 id="感知变化，创造耐心"><a href="#感知变化，创造耐心" class="headerlink" title="感知变化，创造耐心"></a>感知变化，创造耐心</h2><blockquote>
<p>你需要的所有耐心，都已经处在你的内心了。</p>
</blockquote>
<h2 id="4S方法"><a href="#4S方法" class="headerlink" title="4S方法"></a>4S方法</h2><blockquote>
<p>力求简化，将征服大多数复杂的任务。</p>
</blockquote>
<p>简化（simplify）、细分（small）、缩短（short）和放慢（slow）。</p>
<h2 id="平静与DOC方法"><a href="#平静与DOC方法" class="headerlink" title="平静与DOC方法"></a>平静与DOC方法</h2><blockquote>
<p>客观是通往宁静心灵之路。</p>
</blockquote>
<p>“做、观察和纠正（do、observe、correct）</p>
<h2 id="教孩子，也从孩子身上学习"><a href="#教孩子，也从孩子身上学习" class="headerlink" title="教孩子，也从孩子身上学习"></a>教孩子，也从孩子身上学习</h2><blockquote>
<p>智慧并不是年龄的副产品。从你身边所有的人身上学习，同事也用你自己的行动影响身边的人。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2016/12/31/Hexo使用NexT主题时mathjax输入数学公式注意事项/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/Hexo使用NexT主题时mathjax输入数学公式注意事项/" itemprop="url">
                  Hexo使用NexT主题时mathjax输入数学公式注意事项
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T17:33:14+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/31/Hexo使用NexT主题时mathjax输入数学公式注意事项/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/31/Hexo使用NexT主题时mathjax输入数学公式注意事项/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Mathjax号称<code>Beautiful math in all browsers</code>，是展示数学公式方面的好工具。</p>
<h2 id="如何编写Mathjax"><a href="#如何编写Mathjax" class="headerlink" title="如何编写Mathjax"></a>如何编写Mathjax</h2><ul>
<li><a href="http://docs.mathjax.org/en/latest/start.html" target="_blank" rel="external">Mathjax官方文档</a></li>
<li><a href="https://www.codecogs.com/latex/eqneditor.php?lang=zh-cn" target="_blank" rel="external">Mathjax在线生成器</a></li>
<li>在<a href="http://www.typora.io/" target="_blank" rel="external">Typora</a>工具中，使用<code>$$</code>可以编排Mathjax</li>
</ul>
<h2 id="NexT打开Mathjax支持"><a href="#NexT打开Mathjax支持" class="headerlink" title="NexT打开Mathjax支持"></a>NexT打开Mathjax支持</h2><p>默认Hexo的NexT主题是没有打开Mathjax支持的，需要编辑主题的<code>_config.xml</code>文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># MathJax Support</div><div class="line">mathjax:</div><div class="line">  enable: false</div><div class="line">  per_page: false</div><div class="line">  cdn: //cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML</div></pre></td></tr></table></figure>
<p>将<code>enable：false</code>设为<code>enable：true</code>。</p>
<h2 id="复制别人的mathjax代码"><a href="#复制别人的mathjax代码" class="headerlink" title="复制别人的mathjax代码"></a>复制别人的mathjax代码</h2><ul>
<li>查看网页源码。</li>
<li>在公式上右键，<code>Show Math As</code>-&gt;<code>Tex Commande</code></li>
</ul>
<h2 id="重要注意事项"><a href="#重要注意事项" class="headerlink" title="重要注意事项"></a>重要注意事项</h2><ul>
<li>在markdown中使用mathjax下标<code>_</code>时，记得一定要改写成<code>\_</code>，否则将会出现不能解析的情况。</li>
</ul>
<p>状态如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\overline&#123;x&#125;=\frac&#123;x_&#123;1&#125;+x_&#123;2&#125;…x_&#123;n&#125;&#125;&#123;n&#125;</div></pre></td></tr></table></figure>
<p>$$<br>\overline{x}=\frac{x<em>{1}+x</em>{2}…x_{n}}{n}<br>$$</p>
<p>修改后:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\overline&#123;x&#125;=\frac&#123;x\_&#123;1&#125;+x\_&#123;2&#125;…x\_&#123;n&#125;&#125;&#123;n&#125;</div></pre></td></tr></table></figure>
<p>$$<br>\overline{x}=\frac{x_{1}+x_{2}…x_{n}}{n}<br>$$</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.kissingwolf.com/2016/12/31/深入浅出学统计-笔记/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kevin Zou">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Kissingwolf's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Kissingwolf's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/深入浅出学统计-笔记/" itemprop="url">
                  深入浅出学统计-笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T12:48:49+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/31/深入浅出学统计-笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/31/深入浅出学统计-笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="随机抽样"><a href="#随机抽样" class="headerlink" title="随机抽样"></a>随机抽样</h2><blockquote>
<p>随机样本的关键特性是：它作为其来源的总体<code>没有系统性的差别</code></p>
</blockquote>
<p><code>样本</code>是关于特定<code>变量</code>的一个独立观测值集合。当<code>样本</code>由<code>随机</code>采集的观测值组成，且其中每个观测值与其他观测值<code>相互独立</code>时，我们称其为<code>随机样本</code>。</p>
<blockquote>
<p>简单随机样本</p>
</blockquote>
<p>一个大小为n的<code>简单随机样本（SRS）</code>是n个观测值的集合，且抽取方法满足：<code>所有可能从总体抽取的</code>，包含n个观测值的样本都有<code>相等的机会被抽到</code>。</p>
<p>不论是否选择<code>随机抽样技术</code>，都必须<code>确保所得到的样本是总体的代表</code>。否则，随后的一切工作都毫无意义。</p>
<h2 id="样本大小（n）"><a href="#样本大小（n）" class="headerlink" title="样本大小（n）"></a>样本大小（n）</h2><blockquote>
<p>样本大小即单一样本中的测量值的总数。</p>
</blockquote>
<p>一般来说，n越大，我们对统计结论的<code>信心</code>越大，但是样本<code>必须</code>是<code>随机</code>的。</p>
<h2 id="样本平均数"><a href="#样本平均数" class="headerlink" title="样本平均数"></a>样本平均数</h2><p>样本平均数的计算公式，将样本中的所有数值都加起来，然后除以样大小。<br>$$<br>\overline{x}=\frac{x_{1}+x_{2}…x_{n}}{n}<br>$$</p>
<blockquote>
<p><code>中位数</code>是一个样本的“<strong>中间值</strong>”，更适合于在存在<code>偏斜</code>的情况下使用；通过去掉一本分<code>最大值</code>和<code>最小值</code>可以算出<code>去尾平均数</code>，在样本存在<code>极致</code>的情况下啊，这种平均数更适合。</p>
</blockquote>
<h2 id="标准差（s）"><a href="#标准差（s）" class="headerlink" title="标准差（s）"></a>标准差（s）</h2><blockquote>
<p>计算标准差的目的是为了了解与平均值的平均距离。</p>
</blockquote>
<ul>
<li>计算每个测量值与样本平均值之间的距离，我们将这个距离称为<code>偏差</code></li>
<li>求出每个<code>偏差</code>的平方根</li>
<li>将说有<code>偏差</code>的平方根加起来</li>
<li>将说有得到的总数和除以n-1（此处得到结果称之为<code>方差</code>)</li>
<li>求以上结果的平方根</li>
</ul>
<p>$$<br>S=\sqrt{\frac{(x_{1}-\overline{x})^{2}+(x_{2}-\overline{x})^{2}+…(x_{n}-\overline{x})^{2}}{n-1}}<br>$$</p>
<h2 id="分布"><a href="#分布" class="headerlink" title="分布"></a>分布</h2><blockquote>
<p><code>分布</code>描述了一个随机变量的所有可能数值的位置情况。</p>
</blockquote>
<p>如果你用一个总体中的某个变量的所有数值画一张直方图，就会看到该变量的<code>总体分布</code>。</p>
<p>通过<code>分布</code>可以计算特定区域中的随机抽取值的<code>概率（即长期可能性）</code>。</p>
<h2 id="样本统计值与总体参数"><a href="#样本统计值与总体参数" class="headerlink" title="样本统计值与总体参数"></a>样本统计值与总体参数</h2><blockquote>
<p>统计的目的是利用样本对总体进行猜测。</p>
</blockquote>
<p>“X拔”特指<code>样本平均数</code><br>$$<br>\overline{X}<br>$$<br>“S”特指<code>样本标准差</code><br>$$<br>S<br>$$<br>“缪”特指<code>总体平均数</code><br>$$<br>\mu<br>$$<br>“西格玛”特指<code>总体标准差</code><br>$$<br>\sigma<br>$$<br><code>统计值</code>是我们实际测量的数值，因此是确凿无疑的数值。</p>
<p><code>参数</code>是我们想知道的数值，但只能通过猜测获得。</p>
<h2 id="正态分布"><a href="#正态分布" class="headerlink" title="正态分布"></a>正态分布</h2><blockquote>
<p>正态分布代表了平均数的聚集趋势</p>
</blockquote>
<p>我们可以把正态分布分割为不同的区间，用这些区间描述其中的数值的概率。</p>
<h2 id="抽样分布"><a href="#抽样分布" class="headerlink" title="抽样分布"></a>抽样分布</h2><blockquote>
<p>一个抽样分布就是一个样本统计量的分布</p>
</blockquote>
<h2 id="中心极限定理（CLT）"><a href="#中心极限定理（CLT）" class="headerlink" title="中心极限定理（CLT）"></a>中心极限定理（CLT）</h2><blockquote>
<p>当样本大小N很大时，“X拔”的抽样分布接近正态</p>
</blockquote>
<p>N &gt;= 30时此定理成立，所以我们一般认为样本数大于30时为“大样本”。</p>
<h2 id="概率"><a href="#概率" class="headerlink" title="概率"></a>概率</h2><blockquote>
<p>概率是0-1之间的一个数，它对随机事件的发生可能性进行量化，从长期看，概率越接近1，事件越课程发生。</p>
<p>概率仅仅针对于长期性。</p>
</blockquote>
<p>任何概率分布中的总面积都等于1 。</p>
<h2 id="概率数学"><a href="#概率数学" class="headerlink" title="概率数学"></a>概率数学</h2><blockquote>
<p>微积分技术正是用来计算任何分布内的面积。</p>
</blockquote>
<p>正态分布的概率函数：<br>$$<br>f_{\mu ,\sigma }(x)=\frac{1}{\sigma \sqrt{2\pi }}\exp{-\frac{1}{2\sigma ^{2}} (x-\mu )^{2}}<br>$$</p>
<h2 id="置信区间"><a href="#置信区间" class="headerlink" title="置信区间"></a>置信区间</h2><blockquote>
<p>置信区间是与特定置信水平有关的一类区间估计。</p>
</blockquote>
<p>计算总体平均数的95%置信区间的公式：<br>$$<br>\overline{x}\pm 2(\frac{S}{\sqrt{n}})<br>$$<br>通过改变<code>截尾值</code>来改变<code>置信水平</code>，比如1.3作为截尾值可以确定80%的置信区间。</p>
<h2 id="假设检验"><a href="#假设检验" class="headerlink" title="假设检验"></a>假设检验</h2><blockquote>
<p>我们是否认为我们的统计值与原假设所预测的参数具有足够大的偏差，从而可以有理有据拒绝原假设，而选择另一观点。</p>
</blockquote>
<h2 id="P值"><a href="#P值" class="headerlink" title="P值"></a>P值</h2><blockquote>
<p>在原假设为真的前提下，我们将会观测到的数据的极值不超过我们实际观测到的数据的极值得概率。</p>
</blockquote>
<p>P值是对概率的量度，因此只有从长远考虑时才有意义。</p>
<p>在实践中，如果P值“足够小”，即小于0.05，我们就拒绝原假设。小于0.05的概率所表达的意义和“长期结果为每20次不到1次”所表达的意义相当。</p>
<h2 id="我们总有可能是错的"><a href="#我们总有可能是错的" class="headerlink" title="我们总有可能是错的"></a>我们总有可能是错的</h2><blockquote>
<p>我们的统计总有可能是错误的，这一点永远改变不了。我们是在用长期现象评估短期观察结果，这样的事实必然导致这样的结果。</p>
</blockquote>
<p>假设检验无非是提出了这样的一个问题：“我们出于偶然而得到手头这些结果的可能性有多大？” 通过假设检验无法决定性的推翻或证明任何理论；假设检验只能用来帮助我们质疑原假设。</p>
<h2 id="差值推断"><a href="#差值推断" class="headerlink" title="差值推断"></a>差值推断</h2><p>计算两个总体平均数之间的差值的置信区间公式：<br>$$<br>(\overline{x_{1}}-\overline{x_{2}})\pm 2(\sqrt{\frac{S_{1}^{2}-S_{2}^{2}}{n}})<br>$$</p>
<h2 id="小样本推断"><a href="#小样本推断" class="headerlink" title="小样本推断"></a>小样本推断</h2><blockquote>
<p>如果样本很小（小于30），我们不能使用中心极限定理，而应该使用T分布，只有总体本身是正态分布的时候它才有效。</p>
</blockquote>
<p><code>T分布</code>又称之为<code>学生分布</code>。</p>
<h2 id="方差分析"><a href="#方差分析" class="headerlink" title="方差分析"></a>方差分析</h2><blockquote>
<p>方差分析的作用是组间差异和组内差异进行比较。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/7866894?v=3&u=9eef3eb744c6f9f1767f02c2c490d607be9cc6eb&s=400"
               alt="Kevin Zou" />
          <p class="site-author-name" itemprop="name">Kevin Zou</p>
          <p class="site-description motion-element" itemprop="description">任何复杂纷乱的问题都有简单朴实的解决方案</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kissingwolf" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/kissingwolf" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kissingwolf" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://shell909090.org/" title="Shell's Home" target="_blank">Shell's Home</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://booboowei.github.io/" title="BoobooWei Blog" target="_blank">BoobooWei Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.uplooking.com/" title="尚观科技" target="_blank">尚观科技</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Zou</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"kissingwolf"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


</body>
</html>
